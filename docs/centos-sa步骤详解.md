# centos6.6安装教程.md

### 选择系统：
centos 6.6   64位最小化安装ios镜像包
`http://mirrors.aliyun.com/centos/6.6/isos/x86_64/CentOS-6.6-x86_64-minimal.iso`  
说明: 服务器系统，安装的软件越少越好，minimal包383M。

### 系统安装
- 内存要求  
> 大于406M，才能以文本形式安装，该方式不能自定义磁盘分区情况；  
> 大于632M，才能图形化安装

- 分区  
> `LVM`是 Logical Volume Manager（逻辑卷管理）的简写，它是Linux环境下对磁盘分区进行管理的一种机制。随着Linux的逻辑卷管理功能的出现，这些问题都迎刃而解，用户在无需停机的情况下可以方便地调整各个分区大小。  
> `gpt`分区  
> `mbr`分区，不能处理超过2T的硬盘

- 网络配置（网桥/NAT/Host Only/Internal）
> `NAT`: 只能单向访问，虚拟机可以通过网络访问到主机，主机无法通过网络访问到虚拟机。  
> `网桥`: 桥接网络是指本地物理网卡和虚拟网卡通过VMnet0虚拟交换机进行桥接，物理网卡和虚拟网卡在拓扑图上处于同等地位，那么物理网卡和虚拟网卡就相当于处于同一个网段，虚拟交换机就相当于一台现实网络中的交换机,所以两个网卡的IP地址也要设置为同一网段。  
> `Host Only`: 在Host-Only模式下，虚拟网络是一个全封闭的网络，它唯一能够访问的就是主机。

### 系统配置
- 配置系统语言

```
## 临时生效
export LANG="en_US.UTF-8"  

## 永久生效， 编辑/etc/sysconfig/i18n（最好reboot一下）
sed -i 's/zh_CN.UTF-8/en_US.UTF-8/' /etc/sysconfig/i18n
```

- 配置网络和网卡

> 主要有三个配置文件：  
 网卡配置: `/etc/sysconfig/network-scripts/ifcfg-ethx`  
 dns配置: `/etc/resolv.conf`  
 网络配置: `/etc/sysconfig/network`  

```
** nat网卡
[yongfu@yf-cos ~]$ cat /etc/sysconfig/network-scripts/ifcfg-eth0
DEVICE=eth0
TYPE=Ethernet
UUID=9054a4f0-225b-495d-b367-d9be020f0907
ONBOOT=yes
NM_CONTROLLED=no
BOOTPROTO=dhcp
HWADDR=08:00:27:37:0E:B4
IPV4_FAILURE_FATAL=yes
IPV6INIT=no
NAME="System eth0"

** host-only网卡  
DEVICE=eth1
TYPE=Ethernet
UUID=de77a753-ea1c-4150-a69e-8f749d84a2cf
ONBOOT=yes
NM_CONTROLLED=yes
BOOTPROTO=none
HWADDR=08:00:27:D1:E7:B4
IPADDR=192.168.56.10
PREFIX=24
IPV4_FAILURE_FATAL=yes
IPV6INIT=no
NAME="System eth1"

** dns配置
[yongfu@yf-cos ~]$ cat /etc/resolv.conf
; generated by /sbin/dhclient-script
nameserver 192.168.1.10

** 网络配置
[yongfu@yf-cos ~]$ cat /etc/sysconfig/network
NETWORKING=yes
HOSTNAME=yf-cos
GATEWAY=10.0.2.2
```

- 关闭selinux

```
sed -i 's/SELINUX=enforcing/SELINUX=disabled/' /etc/sysconfig/selinux
sed -i 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config
```

> 说明：
> 1. 有部分软件在selinux模式下安装会出现问题，尤其是编译安装的时候。
> 2. 修改此参数重启生效, 测试命令： getenforce
> 3. 在没关闭selinux的情况下，在启动 Percona mysql的时候也遇到权限问题

- 配置limits数  

> 文件描述符在形式上是一个无符号整数。实际上，它是一个索引值，指向内核为每一个进程所维护的该进程打开文件的记录表。当程序打开一个现有文件或者创建一个新文件时，内核向进程返回一个文件描述符。在程序设计中，一些涉及底层的程序编写往往会围绕着文件描述符展开。但是文件描述符这一概念往往只适用于UNIX、Linux这样的操作系统。
>  
> 标准输入（standard input）的文件描述符是 0  
> 标准输出（standard output）是 1  
> 标准错误（standard error）是 2  
>
> 尽管这种习惯并非Unix内核的特性，但是因为一些 shell 和很多应用程序都使用这种习惯，因此，如果内核不遵循这种习惯的话，很多应用程序将不能使用。

```
[root@yongfu-cos ~]# ulimit -a
core file size          (blocks, -c) 0
data seg size           (kbytes, -d) unlimited
scheduling priority             (-e) 0
file size               (blocks, -f) unlimited
pending signals                 (-i) 7817
max locked memory       (kbytes, -l) 64
max memory size         (kbytes, -m) unlimited
open files                      (-n) 1024
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
real-time priority              (-r) 0
stack size              (kbytes, -s) 10240
cpu time               (seconds, -t) unlimited
max user processes              (-u) 7817
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited


执行如下命令：
echo '* soft nofile 65535' >> /etc/security/limits.conf
echo '* hard nofile 65536' >> /etc/security/limits.conf
```

说明：
1. 突破文件描述符默认为1024的限制
2. 需要理解一个东西，就是linux几乎所有的东西都是一个文件，包括驱动/普通文件/设备等等
```

- 配置iptables
> 根据我们需要创建web服务器的具体需求  
> 开启如下端口：22(ssh), 80(www), 3690(svn)

```
默认的配置为：
[yongfu@yf-cos ~]$ sudo cat /etc/sysconfig/iptables
# Firewall configuration written by system-config-firewall
# Manual customization of this file is not recommended.
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT


默认是开放了22端口的访问， 在这条规则下新增如下规则：
sed  -i '10a -A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT' /etc/sysconfig/iptables
sed  -i '11a -A INPUT -m state --state NEW -m tcp -p tcp --dport 3690 -j ACCEPT' /etc/sysconfig/iptables



重启iptables生效
sudo /etc/init.d/iptables restart
``
查看
sudo iptables -L
```


- 添加普通用户及sudo配置

```
添加普通用户：yongfu 并配置sudo
sudo useradd yongfu
sudo sed  -i '98a yongfu   ALL=(ALL)   NOPASSWD: ALL' /etc/sudoers

添加普通用户：www, mysql
groupadd  www -g 600  
useradd -g  www   -u 600  -s /sbin/nologin  www  
groupadd  mysql -g 27  
useradd -g  mysql   -u 27  -s /sbin/nologin  mysql  
```

- 配置ssh，配置文件及证书

```
在本地机器生成公私钥：
ssh-keygen -t rsa -b 2048

在远程机器创建.ssh目录和authorized_keys文件，特别注意目录和文件权限。
配置用户yongfu的证书登录:
mkdir /home/yongfu/.ssh
echo 'ssh-rsa /giNtoX/70KGkhFp5k3wyviTnp5EdiEGnSni+OqzPCkP7gqqTCVNACJk9kVwHkNU3' >> /home/yongfu/.ssh/authorized_keys
chown yongfu:yongfu -R /home/yongfu/.ssh  
chmod 700 /home/yongfu/.ssh  
chmod 644 /home/yongfu/.ssh/authorized_keys

修改ssh配置:
sed  -i -e 's/#PermitRootLogin yes/PermitRootLogin no/'  \
-e 's/PasswordAuthentication yes/PasswordAuthentication no/' \
-e 's/#UseDNS yes/UseDNS no/' \
/etc/ssh/sshd_config

** 在配置iptables和ssh时要特别小心，不然很可能就导致自己无法远程登录了，修改必须谨慎。
```

- 标准化目录

```
mkdir -p /opt/app /data/www/test /data/logs/nginx /data/logs/php
chown www:www -R /data/www/test  /data/logs 
mkdir -p /data/mysql /var/lib/mysql /var/run/mysqld
chown mysql:mysql -R /data/mysql /var/lib/mysql /var/run/mysqld
```

### nmp安装篇
#### 系统初始化软件包
- 更新系统

>	`yum update`  
>	第一次使用时，最好把系统更新到最新，并重新启动

- 安装基础包

>   基础系统(不包括在最小系统包中，但又常用的软件):
>	`yum -y install curl wget  man vim yum-priorities ntpdate`
>
>	编译依赖的软件  
>	`yum -y install make gcc`

- 安装epel源

>	安装epel源(URL需按实际情况修改)
>  `rpm -Uvh http://mirrors.ustc.edu.cn/fedora/epel/6/x86_64/epel-release-6-8.noarch.rpm`
>  
>	查看是否安装成功  
>	`rpm -q epel-release`  
>
>	导入key：  
>	`rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6`  
>
>	修改yum优先级(先去官方源查，没有再去查epel源)
>  `sed -i '8a  priority=11' /etc/yum.repos.d/epel.repo`
>
>	重建缓存  
>	`yum makecache`


- 时间同步  
```
echo '10 7 * * * /usr/sbin/ntpdate ntp.fudan.edu.cn' > /var/spool/cron/root
```

- svn安装配置

```
安装svn
yum -y install subversion

初始化svn库
svnadmin create /data/svn

修改svn配置文件
sed -i -e 's/# anon-access = read/anon-access = none/' \
-e 's/# auth-access = write/auth-access = write/' \
-e 's/# password-db = passwd/password-db = passwd/' \
-e 's/# realm = My First Repository/realm = svn/' \
/data/svn/conf/svnserve.conf

设置用户权限
echo "
[/]
leon = rw
* = r " >> /data/svn/conf/authz

设置用户及密码
echo "leon = 123456" >> /data/svn/conf/passwd

启动svn
svnserve -d -r /data/svn

开机启动
echo "svnserve -d -r /data/svn" >> /etc/rc.local
```

### 安装nmp
定义目录：
CompileDir=/opt/LStarter
AppInstallDir=/opt/app

- 编译安装nginx

```
准备的软件：
wget http://nginx.org/download/nginx-1.6.2.tar.gz
wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.36.tar.gz

解决依赖：
yum install -y zlib-devel openssl-devel  gcc-c++

编译安装：
cd $CompileDir
tar xzf nginx-1.6.2.tar.gz
cd nginx-1.6.2
./configure --prefix=$AppInstallDir/nginx --user=www --group=www --with-http_stub_status_module --with-openssl=/usr/ --with-pcre=$CompileDir/pcre-8.36
make
make install

说明：
--with-pcre 接的参数为pcre的解压缩目录

配置及启动脚本：
mkdir -p $AppInstallDir/nginx/conf/conf.d
/bin/cp -f $CompileDir/conf/nginx.conf $AppInstallDir/nginx/conf/
/bin/cp -f $CompileDir/conf/nginx_default_site.conf $AppInstallDir/nginx/conf/conf.d/
/bin/cp -f $CompileDir/conf/nginx_init /etc/init.d/nginx
chmod +x /etc/init.d/nginx

开机启动：
chkconfig --add nginx
```

- 安装mysql(Percona)

```
安装方法1：yum安装
yum -y install http://www.percona.com/downloads/percona-release/redhat/0.1-3/percona-release-0.1-3.noarch.rpm
yum -y install Percona-Server-client-56.x86_64 Percona-Server-server-56.x86_64


安装方法2：rpm安装
http://repo.percona.com/release/centos/6Server/RPMS/x86_64/Percona-Server-server-56-5.6.22-rel71.0.el6.x86_64.rpm
http://repo.percona.com/release/centos/6Server/RPMS/x86_64/Percona-Server-client-56-5.6.22-rel71.0.el6.x86_64.rpm
http://repo.percona.com/release/centos/6Server/RPMS/x86_64/Percona-Server-shared-56-5.6.22-rel71.0.el6.x86_64.rpm

rpm -ivh Percona-Server-server-56-5.6.22-rel71.0.el6.x86_64.rpm Percona-Server-client-56-5.6.22-rel71.0.el6.x86_64.rpm Percona-Server-shared-56-5.6.22-rel71.0.el6.x86_64.rpm

安装方法3：编译安装
略

切记：需关闭selinux，或做好selinux的策略

配置：
/bin/cp -f $CompileDir/conf/my.cnf /etc/my.cnf
/usr/bin/mysql_install_db

/etc/init.d/mysql start
sleep 8

/usr/bin/mysql -u root  -e "delete from mysql.user where user=''"
/usr/bin/mysqladmin -u root password "pass123"

```

- 安装php

```
下载源码：
wget http://cn2.php.net/distributions/php-5.5.21.tar.gz
wget https://github.com/phpredis/phpredis/archive/2.2.7.zip -O phpredis-2.2.7.zip

yum -y install zip unzip autoconf automake gcc gcc-c++ zlib-devel openssl openssl-devel pcre-devel gd     compat-glibc compat-glibc-headers cpp freetype freetype-devel libjpeg libjpeg-devel  libpng libpng-devel ncurses ncurses-devel libtool libtool-ltdl libtool-ltdl-devel  libxml2 libxml2-devel curl-devel libcurl-devel bison flex gmp gmp-devel bzip2-devel file libXpm libXpm-devel re2c libmcrypt-devel.x86_64 libmcrypt.x86_64 

tar xzf php-5.5.21.tar.gz
cd php-5.5.21
./configure  --prefix=$AppInstallDir/php55 --with-mysql --with-pdo-mysql --with-mysqli --with-gd --with-zlib --enable-bcmath --enable-shmop --with-curl --enable-fpm --enable-mbstring --enable-gd-native-ttf --with-openssl --enable-pcntl --enable-sockets --with-xmlrpc --enable-zip --enable-soap --without-pear --with-gettext --with-mcrypt --with-libdir=lib64 --with-freetype-dir=/usr --with-png-dir=/usr --enable-sysvmsg --enable-sysvshm --enable-sysvsem --with-gmp --with-jpeg-dir=/usr --with-libxml-dir=/usr --disable-phar --enable-exif --with-bz2
make && make install

配置php：
/bin/cp -f sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm
chmod +x /etc/init.d/php-fpm
/bin/cp -f $CompileDir/conf/php.ini $AppInstallDir/php55/lib/php.ini
/bin/cp -f $CompileDir/conf/php-fpm.conf $AppInstallDir/php55/etc/php-fpm.conf

phpredis扩展
unzip phpredis-2.2.7.zip
cd phpredis-2.2.7
$AppInstallDir/php55/bin/phpize
./configure --with-php-config=$AppInstallDir/php55/bin/php-config
make && make install

开机启动
chkconfig --add php-fpm
```

### 安装phpmyadmin
wget http://jaist.dl.sourceforge.net/project/phpmyadmin/phpMyAdmin/4.3.8/phpMyAdmin-4.3.8-all-languages.zip  
unzip phpMyAdmin-4.3.8-all-languages.zip

cp -rf phpMyAdmin-4.3.8-all-languages /data/www/pma
cp -f $CompileDir/conf/nginx_phpmyadmin.conf /opt/app/nginx/conf/conf.d/nginx_phpmyadmin.conf
cp -f $CompileDir/conf/config.default.php /data/www/pma/libraries/config.default.php

chown www:www -R /data/www/pma

## 当iptable没有设置时，在此设置
grep '--dport 8080' /etc/sysconfig/iptables >/dev/null 2>&1
if [ $? -ne 0 ]; then
    sed -i '10a -A INPUT -m state --state NEW -m tcp -p tcp --dport 8080 -j ACCEPT' /etc/sysconfig/iptables
fi

rm -rf phpMyAdmin-4.3.8-all-languages
